<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Script Page</title>
<style>
html, body {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    overflow-y: auto;
    font-family: Arial, sans-serif;
    background-color: black;
    color: white;
    height: 100%;
    width: 100%;
}

body {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    padding: 20px;
    box-sizing: border-box;
}

/* Top button bar */
#top-buttons {
    position: fixed;
    top: 15px;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 10;
}

/* All buttons */
button, input[type="file"] {
    padding: 10px 20px;
    font-size: 18px;
    background-color: black;
    color: white;
    border: 2px solid white;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s, color 0.3s;
}

button:hover, input[type="file"]:hover {
    background-color: green;
    color: white;
}

/* File name display */
#fileNameTitle {
    margin-top: 70px; /* space under top buttons */
    font-size: 18px;
    color: white;
}

/* Output box */
#output {
    white-space: pre-wrap;
    text-align: left;
    margin-top: 20px;
    background-color: black;
    border: 1px solid white;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 800px;
}

/* Controls */
#controls {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-top: 40px;
    gap: 30px;
}

#nextButton {
    width: calc(100% - 40px);
    max-width: 800px;
    height: 130px;
    border-radius: 20px;
    font-size: 60px;
    margin: 0 20px;
}

.sub-buttons {
    display: flex;
    justify-content: center;
    gap: 30px;
}

.sub-buttons button {
    font-size: 18px;
    padding: 10px 20px;
    border-radius: 10px;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
</head>
<body>
<!-- Top button bar -->
<div id="top-buttons">
    <button id="clearButton">X</button>
    <button id="processButton" style="display:none;">Roles</button>
    <button id="resetButton"><<</button>
</div>

<!-- File name display -->
<h2 id="fileNameTitle"></h2>

<!-- File upload -->
<input type="file" id="fileInput" accept=".pdf">

<div id="output"></div>

<div id="controls">
    <button id="nextButton">&gt;</button>
    <div class="sub-buttons">
        <button id="backButton">Back</button>
        <button id="skipAheadButton">Skip Ahead</button>
        <button id="muteButton">Mute</button>
    </div>
</div>

<script>
const fileInput = document.getElementById('fileInput');
const processButton = document.getElementById('processButton');
const resetButton = document.getElementById('resetButton');
const clearButton = document.getElementById('clearButton');
const outputDiv = document.getElementById('output');
const controls = document.getElementById('controls');
const nextButton = document.getElementById('nextButton');
const backButton = document.getElementById('backButton');
const skipAheadButton = document.getElementById('skipAheadButton');
const muteButton = document.getElementById('muteButton');
const fileNameTitle = document.getElementById('fileNameTitle');

let characterChoices = {};
let lines = [];
let currentLineIndex = -1;
let voices = [];
let isMuted = false;
let pdfLoaded = false;

fileInput.addEventListener('change', handleFileChange);
processButton.addEventListener('click', handleProcessScript);

// ðŸ”Š Modified nextButton click to include warm chord
nextButton.addEventListener('click', () => {
    playClickChord(); // Play soft chord
    navigateLine(1);
    // Vibrate phone for 50ms
    if (navigator.vibrate) navigator.vibrate(50);
});

backButton.addEventListener('click', () => navigateLine(-1));
skipAheadButton.addEventListener('click', skipAhead);
muteButton.addEventListener('click', toggleMute);
resetButton.addEventListener('click', resetScene);
clearButton.addEventListener('click', clearPDF);

speechSynthesis.onvoiceschanged = loadVoices;

function toggleMute() {
    isMuted = !isMuted;
    muteButton.textContent = isMuted ? "Unmute" : "Mute";
    muteButton.style.backgroundColor = isMuted ? "green" : "black";
    muteButton.style.color = "white";
    if (isMuted) speechSynthesis.cancel();
}

function handleFileChange() {
    const file = fileInput.files[0];
    if (file) {
        pdfLoaded = true;
        fileInput.style.display = "none";
        fileNameTitle.textContent = stripExtension(file.name);
        processButton.style.display = "inline-block";
    }
}

function stripExtension(filename) {
    return filename.replace(/\.[^/.]+$/, "");
}

function loadVoices() {
    voices = speechSynthesis.getVoices();
}

function handleProcessScript() {
    const file = fileInput.files[0];
    if (!file) return alert("Please upload a script.");

    const reader = new FileReader();
    reader.onload = (e) => {
        const typedArray = new Uint8Array(e.target.result);
        pdfjsLib.getDocument(typedArray).promise.then(pdf =>
            Promise.all(Array.from({ length: pdf.numPages }, (_, i) => 
                pdf.getPage(i + 1).then(page => page.getTextContent())
            ))
        )
        .then(textContentArray => {
            const fullText = textContentArray.flatMap(tc => tc.items.map(item => item.str)).join(' ');
            identifyCharacters(fullText);
        });
    };
    reader.readAsArrayBuffer(file);
}

function identifyCharacters(scriptText) {
    const regex = /([A-Z]{2,})[,.]\s*(.+?)(?=[A-Z]{2,}[,.]\s*|$)/gs;
    const characters = new Set();
    let match;
    while ((match = regex.exec(scriptText)) !== null) characters.add(match[1].trim());
    if (characters.size > 0) displayCharacterSelection([...characters], scriptText);
    else alert("No characters found.");
}

function displayCharacterSelection(characters, scriptText) {
    outputDiv.innerHTML = '<h2>Select Voice Type for Each Character</h2>';
    const form = document.createElement('form');

    characters.forEach(character => {
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `
            <label style="margin-right:10px;">${character}:</label>
            <select name="${character}" style="
                padding:5px 10px; 
                font-size:16px; 
                border-radius:5px; 
                border:2px solid white; 
                background-color:black; 
                color:white;
                ">
                <option value="masc">Masc</option>
                <option value="fem">Fem</option>
                <option value="mute">Mute (Show only)</option>
                <option value="skip">Skip (Completely ignore)</option>
            </select>
        `;
        form.appendChild(div);
    });

    const submitButton = document.createElement('button');
    submitButton.textContent = 'Done';
    submitButton.style.backgroundColor = 'black';
    submitButton.style.color = 'white';
    submitButton.style.border = '2px solid white';
    submitButton.style.padding = '10px 20px';
    submitButton.style.fontSize = '18px';
    submitButton.style.borderRadius = '5px';
    submitButton.style.cursor = 'pointer';

    submitButton.addEventListener('mouseover', () => {
        submitButton.style.backgroundColor = 'green';
        submitButton.style.color = 'white';
    });
    submitButton.addEventListener('mouseout', () => {
        submitButton.style.backgroundColor = 'black';
        submitButton.style.color = 'white';
    });

    submitButton.addEventListener('click', (event) => {
        event.preventDefault();
        new FormData(form).forEach((value, key) => characterChoices[key] = value);
        processScriptWithSelections(scriptText);
    });

    form.appendChild(submitButton);
    outputDiv.appendChild(form);
}

function processScriptWithSelections(scriptText) {
    const regex = /([A-Z]{2,})[,.]\s*(.+?)(?=[A-Z]{2,}[,.]\s*|$)/gs;
    lines = [];
    let match;
    while ((match = regex.exec(scriptText)) !== null) {
        const speaker = match[1].trim();
        const line = match[2].trim();
        const choice = characterChoices[speaker];
        const prefix = getPrefix(choice);
        lines.push({ prefix, speaker, line, choice });
    }
    controls.style.display = 'flex';
    navigateLine(1);
}

function getPrefix(choice) {
    return choice === 'masc' ? '++' :
           choice === 'fem' ? '--' :
           choice === 'mute' ? '!!' :
           choice === 'skip' ? 'xx' : '';
}

function navigateLine(direction) {
    currentLineIndex += direction;
    while (currentLineIndex >= 0 && currentLineIndex < lines.length && lines[currentLineIndex].choice === 'skip') {
        currentLineIndex += direction;
    }
    if (currentLineIndex < 0 || currentLineIndex >= lines.length) {
        controls.style.display = 'none';
        outputDiv.innerHTML = "<h2>No more lines to read!</h2>";
        return;
    }
    const { prefix, speaker, line } = lines[currentLineIndex];
    const displayLine = line.replace(/\(.*?\)/g, '').trim();
    outputDiv.innerHTML = `<h2>${speaker}: ${displayLine}</h2>`;
    if (!isMuted && prefix !== '!!' && prefix !== 'xx') speak(prefix + " " + line, displayLine);
    else speechSynthesis.cancel();
}

function resetScene() {
    if (lines.length === 0) return;
    currentLineIndex = -1;
    navigateLine(1);
}

function clearPDF() {
    pdfLoaded = false;
    fileInput.value = "";
    fileInput.style.display = "inline-block";
    fileNameTitle.textContent = "";
    outputDiv.innerHTML = "";
    controls.style.display = "none";
    processButton.style.display = "none";
    speechSynthesis.cancel();
}

function skipAhead() {
    let nextIndex = -1;
    for (let i = currentLineIndex + 1; i < lines.length; i++) {
        if (lines[i].choice === 'mute' || lines[i].choice === 'skip') {
            nextIndex = i;
            break;
        }
    }
    if (nextIndex === -1 || nextIndex <= currentLineIndex + 1) {
        currentLineIndex = lines.length;
        controls.style.display = 'none';
        outputDiv.innerHTML = "<h2>No more lines to read!</h2>";
        return;
    }
    currentLineIndex = nextIndex - 1;
    navigateLine(0);
}

function speak(originalLine, text) {
    const utterance = new SpeechSynthesisUtterance(text);
    const isMale = originalLine.startsWith('++');
    const isFemale = originalLine.startsWith('--');
    utterance.voice = voices.find(voice => isMale ? voice.name.includes('Male') : isFemale ? voice.name.includes('Female') : true) || voices[0];
    utterance.pitch = 1.2;
    utterance.rate = 0.9;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
}

// ðŸ”‰ Function to play a warm, soft chord when pressing ">"
function playClickChord() {
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const now = audioCtx.currentTime;

    // Gentle C major chord (C4, E4, G4)
    const freqs = [261.63, 329.63, 392.00];

    freqs.forEach(f => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();

        osc.type = "sine";
        osc.frequency.setValueAtTime(f, now);
        gain.gain.setValueAtTime(0.08, now);
        gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.4);

        osc.connect(gain).connect(audioCtx.destination);
        osc.start(now);
        osc.stop(now + 0.4);
    });
}
</script>
</body>
</html>